<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>ASV DApp â€” Avatar Vivo AURION SOVRA</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
<style>
Â  :root{
Â  Â  --bg:#070b14;--card:#0d1322;--ink:#e7eef7;--muted:#93a3b8;
Â  Â  /* Paleta AURION SOVRA */
Â  Â  --brand:#00ff88; /* Verde NeÃ³n Principal */
Â  Â  --secondary:#7c3aed; /* PÃºrpura Secundario */
Â  Â  --ok:#22c55e;--warn:#f59e0b;--err:#ef4444;--line:#20283a;
Â  Â  --matrix:#00ff41;
Â  }
Â  *{box-sizing:border-box} html,body{height:100%}
Â  body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui;display:flex}
Â  .shell{width:100%;max-width:1080px;margin:auto;display:flex;flex-direction:column;gap:14px;padding:16px}
Â  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
Â  header.card{padding:14px;display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
Â  .title{display:flex;align-items:center;gap:10px}
Â  .title h1{margin:0;font-size:18px;background:linear-gradient(135deg,var(--brand),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
Â  .tag{font-size:12px;border:1px solid rgba(0,255,136,.5);color:#8bffd6;border-radius:999px;padding:2px 8px;background:rgba(0,255,136,.12)}
Â  .actions{display:flex;gap:8px;flex-wrap:wrap}
Â  .btn{border:1px solid var(--line);background:#111a2e;color:var(--ink);padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;transition:all .3s}
Â  .btn:hover{transform:translateY(-1px)}
Â  .btn.primary{background:var(--brand);color:#05262f;border:none}
Â  .btn.wallet{background:#f6851b;border:none;color:white}
Â  .btn.mic{background:linear-gradient(135deg,var(--secondary),#8b5cf6);color:white;border:none}
Â  .btn:disabled{opacity:.65;cursor:not-allowed}
Â  .rows{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
Â  @media (max-width:960px){.rows{grid-template-columns:1fr}}
Â  /* Vitalidad */
Â  .v-wrap{grid-column:1/-1}
Â  .vital{height:12px;background:#0b1326;border:1px solid var(--line);border-radius:999px;overflow:hidden}
Â  .vital>div{height:100%;width:34%;background:linear-gradient(90deg,var(--brand),#41f0a6);transition:width .5s ease, background .3s}
Â  .muted{color:var(--muted);font-size:12px}
Â  /* Chat */
Â  .chat.card{display:flex;flex-direction:column;min-height:520px;overflow:hidden}
Â  .chat-head{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:8px}
Â  .history{flex:1;overflow:auto;padding:14px;display:flex;flex-direction:column;gap:10px;background:radial-gradient(1200px 400px at 10% -10%,rgba(0,255,136,.09),transparent)}
Â  .msg{max-width:78%;padding:10px 14px;border-radius:14px;line-height:1.5;font-size:14px;white-space:pre-wrap}
Â  .msg .ts{opacity:.7;font-size:11px;margin-right:6px}
Â  .msg.user{align-self:flex-end;background:var(--brand);color:#072c34;border-bottom-right-radius:6px}
Â  .msg.bot{align-self:flex-start;background:#0a1226;border:1px solid var(--line);border-bottom-left-radius:6px}
Â  .composer{display:grid;grid-template-columns:1fr auto auto auto;gap:8px;padding:12px;border-top:1px solid var(--line)}
Â  input[type=text]{padding:12px;border-radius:10px;border:1px solid var(--line);background:#0b1326;color:var(--ink)}
Â  .tiny{font-size:12px;opacity:.85}
Â  /* Avatar con Matriz Viviente (Imagen de Fondo) */
Â  .avatar.card{padding:14px;display:flex;gap:14px;align-items:center}
Â  .face-wrap{
Â  Â  position:relative;width:160px;height:160px;border-radius:50%;overflow:hidden;
Â  Â  border:1px solid var(--line);
Â  Â  /* Usar la imagen como fondo */
Â  Â  background:url('IMG_1994.png') center center/cover no-repeat;
Â  Â  transition:transform 0.5s ease, filter 0.5s ease;
Â  }
Â  #matrix-glitch{
Â  Â  position:absolute;top:-10px;left:-10px;width:180px;height:180px;border-radius:50%;
Â  Â  background:radial-gradient(circle,rgba(0,255,65,0.1) 0%,transparent 70%);
Â  Â  opacity:0;pointer-events:none;z-index:2;mix-blend-mode:screen;
Â  }
Â  #face-overlay{
Â  Â  position:absolute;top:0;left:0;width:100%;height:100%;border-radius:50%;
Â  Â  background-color:rgba(0,0,0,0);transition:background-color 0.05s ease;z-index:1;
Â  }
Â  /* Ocultar el canvas ya que usamos una imagen de fondo */
Â  canvas#face{display:none}
Â  .hud{display:flex;flex-direction:column;gap:6px}
Â  .dot{display:inline-block;width:10px;height:10px;border-radius:999px;background:#41f0a6;box-shadow:0 0 12px #41f0a6}
Â  /* Payments */
Â  .pay.card{padding:14px;display:flex;flex-direction:column;gap:10px}
Â  .row{display:grid;grid-template-columns:140px 1fr;gap:10px;align-items:center}
Â  .row input{padding:10px;border-radius:8px;border:1px solid var(--line);background:#0b1326;color:var(--ink)}
Â  .pay-form{display:none;flex-direction:column;gap:10px;border-top:1px dashed var(--line);padding-top:10px}
Â  /* Notifications */
Â  #toasts{position:fixed;top:16px;right:16px;display:flex;flex-direction:column;gap:8px;z-index:9999}
Â  .toast{padding:10px 14px;border-radius:10px;color:#041316;box-shadow:0 8px 26px rgba(0,0,0,.35);transform:translateX(120%);opacity:0;transition:.35s}
Â  .toast.show{transform:none;opacity:1}
Â  .t-info{background:#77ecff}.t-success{background:#9ef5b9}.t-warn{background:#ffe08a}.t-err{background:#ffb1b1}
Â  /* Animaciones Matriz */
Â  @keyframes cognitive-pulse{0%{transform:scale(1.0) rotate(0deg);opacity:0.1}50%{transform:scale(1.02) rotate(0.5deg);opacity:0.3}100%{transform:scale(1.0) rotate(0deg);opacity:0.1}}
Â  @keyframes digital-flicker{0%,100%{opacity:0.3}50%{opacity:0.1}25%,75%{opacity:0.4}}
</style>
</head>
<body>
<div class="shell">
Â  <header class="card">
Â  Â  <div class="title">
Â  Â  Â  <h1>ğŸ§¬ AURION SOVRA AI</h1><span class="tag">Avatar Vivo Â· Web3 Â· ASV-A</span>
Â  Â  </div>
Â  Â  <div class="actions">
Â  Â  Â  <button id="btn-theme" class="btn">ğŸŒ™ Tema</button>
Â  Â  Â  <button id="btn-mic" class="btn mic">ğŸ¤ Escuchar</button>
Â  Â  Â  <button id="btn-speak" class="btn">ğŸ—£ï¸ Voz ON</button>
Â  Â  Â  <button id="btn-connect" class="btn wallet">ğŸ”— Conectar Wallet</button>
Â  Â  </div>
Â  Â  <div class="v-wrap">
Â  Â  Â  <div class="vital"><div id="vbar" style="width:34%"></div></div>
Â  Â  Â  <div class="muted" id="vlabel" style="margin-top:6px">Vitalidad: 34%</div>
Â  Â  </div>
Â  </header>

Â  <div class="rows">
Â  Â  <section class="chat card">
Â  Â  Â  <div class="chat-head">
Â  Â  Â  Â  <strong>ConversaciÃ³n con AURION SOVRA</strong>
Â  Â  Â  Â  <span class="muted" id="addr">Wallet: â€”</span>
Â  Â  Â  </div>
Â  Â  Â  <div id="history" class="history"></div>
Â  Â  Â  <div class="composer">
Â  Â  Â  Â  <input id="prompt" type="text" placeholder="Habla o escribe con tu avatar..." maxlength="500" />
Â  Â  Â  Â  <button id="btn-send" class="btn primary">Enviar</button>
Â  Â  Â  Â  <button id="btn-clear" class="btn">ğŸ§¹ Limpiar</button>
Â  Â  Â  Â  <span class="tiny" id="mem-indicator">Memoria: local</span>
Â  Â  Â  </div>
Â  Â  </section>

Â  Â  <aside>
Â  Â  Â  <div class="avatar card">
Â  Â  Â  Â  <div class="face-wrap" id="faceWrap">
Â  Â  Â  Â  Â  <div id="matrix-glitch"></div>
Â  Â  Â  Â  Â  <div id="face-overlay"></div>
Â  Â  Â  Â  Â  <canvas id="face" width="320" height="320"></canvas>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="hud">
Â  Â  Â  Â  Â  <div><strong>Estado:</strong> <span id="state">inicializandoâ€¦</span></div>
Â  Â  Â  Â  Â  <div><strong>EmociÃ³n:</strong> <span id="emotion">idle</span> <span class="dot" id="dot"></span></div>
Â  Â  Â  Â  Â  <div class="muted">Microgestos y matriz viviente activos</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="pay card">
Â  Â  Â  Â  <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
Â  Â  Â  Â  Â  <strong>ğŸ’³ EconomÃ­a ASV-A</strong>
Â  Â  Â  Â  Â  <span class="muted">Token: <code id="taddr">â€”</code></span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="phint" class="muted">SugerirÃ© recargas cuando mi energÃ­a estÃ© baja</div>
Â  Â  Â  Â  <div id="pform" class="pay-form">
Â  Â  Â  Â  Â  <div class="row"><label>RazÃ³n</label><input id="preason" type="text" readonly></div>
Â  Â  Â  Â  Â  <div class="row"><label>Destinatario</label><input id="pto" type="text" readonly></div>
Â  Â  Â  Â  Â  <div class="row"><label>Cantidad (ASV-A)</label><input id="pamt" type="text" readonly></div>
Â  Â  Â  Â  Â  <button id="btn-pay" class="btn primary">âœ… Confirmar Pago</button>
Â  Â  Â  Â  Â  <div class="muted">Al confirmar en MetaMask, mi vitalidad se restaurarÃ¡</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </aside>
Â  </div>
</div>

<div id="toasts"></div>

<script>
// ========= CONFIG =========
const TOKEN_ADDRESS = "0x2682FA44105a60F2016FAa8909eA82d3d427bfFc";
const TOKEN_DECIMALS_DEFAULT = 18;
const THRESHOLD_100 = 1000;
const STORAGE_KEY = "ASV_AURION_SOVRA_HISTORY";

// ========= UTIL & UI =========
const $ = id => document.getElementById(id);
const ts = () => new Date().toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'});
const addToast = (msg, kind='t-info', ms=4000)=>{
Â  const n=document.createElement('div'); n.className=`toast ${kind}`; n.textContent=msg;
Â  $('toasts').appendChild(n); requestAnimationFrame(()=>n.classList.add('show'));
Â  setTimeout(()=>{n.classList.remove('show'); setTimeout(()=>n.remove(),4000)}, ms);
};
function pushMsg(role, content){
Â  state.history.push({role,content,timestamp:ts()});
Â  const d=document.createElement('div'); d.className=`msg ${role==='user'?'user':'bot'}`;
Â  d.innerHTML=`<span class="ts">${ts()}:</span> ${content}`;
Â  const h=$('history'); h.appendChild(d); h.scrollTop=h.scrollHeight;
Â  if(state.voiceOn && role!=='user') speak(content);
Â  saveHistory();
}
function saveHistory(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state.history.slice(-40))); }catch{} }
function loadHistory(){
Â  try{ const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return;
Â  Â  const arr=JSON.parse(raw); if(!Array.isArray(arr)) return;
Â  Â  state.history = arr; arr.forEach(m=>{
Â  Â  Â  const d=document.createElement('div'); d.className=`msg ${m.role==='user'?'user':'bot'}`;
Â  Â  Â  d.innerHTML=`<span class="ts">${m.timestamp||ts()}:</span> ${m.content}`;
Â  Â  Â  $('history').appendChild(d);
Â  Â  }); $('history').scrollTop=$('history').scrollHeight;
Â  }catch{}
}

// ========= STATE =========
const state = {
Â  vitality: 34, emotion: 'idle', history: [],
Â  provider: null, signer: null, token: null, tokenDecimals: TOKEN_DECIMALS_DEFAULT,
Â  account: null, sending:false, listening:false, voiceOn:false, isSpeaking:false
};

// ========= VITALIDAD & EMOCIÃ“N =========
function setVitality(p){
Â  const v = Math.max(0,Math.min(100,Math.round(p)));
Â  state.vitality = v;
Â  $('vbar').style.width = v+'%';
Â  $('vlabel').textContent = `Vitalidad: ${v}%`;
Â  // Degradado Vitalidad
Â  $('vbar').style.background = v<25 ? 'linear-gradient(90deg,#ef4444,#f59e0b)'
Â  Â  : (v<50 ? 'linear-gradient(90deg,#f59e0b,#fde047)'
Â  Â  : 'linear-gradient(90deg,var(--brand),#41f0a6)');
Â  drawFace(v);
Â  setEmotion(v>70?'happy':(v>=45?'neutral':(v>=25?'tired':'low')));
}
function setEmotion(tag){
Â  state.emotion = tag;
Â  $('emotion').textContent = tag;
Â  // Actualizar color del DOT segÃºn la emociÃ³n/estado
Â  $('dot').style.background = tag==='happy'?'#22c55e':(tag==='neutral'?'#00ff88':(tag==='tired'?'#f59e0b':'#ef4444'));
Â  $('dot').style.boxShadow = `0 0 12px ${tag==='happy'?'#22c55e':(tag==='neutral'?'#00ff88':(tag==='tired'?'#f59e0b':'#ef4444'))}`;
}

// ========= AVATAR CON MATRIZ VIVIENTE (IMAGEN DE FONDO + CSS) =========
// NOTA: El Canvas ahora estÃ¡ oculto y se usa IMG_1994.png como fondo de face-wrap.
const faceWrap = $('faceWrap'), matrixGlitch = $('matrix-glitch'), faceOverlay = $('face-overlay');
let blinkT=0, gaze={x:0,y:0}, rotation=0; 

function drawFace(vital=40){
Â  // Control de efectos de matriz y filtro (brillo, contraste)
Â  let brightness = 1 + (vital - 50) / 50 * 0.15; // MÃ¡s brillo en alta vitalidad
Â  let contrast = 1 + (vital - 50) / 50 * 0.1;
Â  faceWrap.style.filter = `brightness(${brightness}) contrast(${contrast})`;
Â Â 
Â  // MATRIZ VIVIENTE (CSS Overlay)
Â  const matrixIntensity = Math.min(0.3, (vital/100)*0.3);
Â  matrixGlitch.style.opacity = matrixIntensity;
Â  if(vital > 20){
Â  Â  matrixGlitch.style.animation = `cognitive-pulse ${2.5-(vital/100)*1.5}s infinite`;
Â  Â  rotation += (vital/100)*0.05;
Â  Â  matrixGlitch.style.transform = `rotate(${rotation}deg)`;
Â  } else {
Â  Â  matrixGlitch.style.animation = 'none';
Â  }
Â Â 
Â  // Efecto glitch en vitalidad baja
Â  if(vital < 20){
Â  Â  faceWrap.style.transform = `scale(0.98) rotate(${Math.sin(Date.now()/50)*0.5}deg)`;
Â  Â  $('state').textContent='hibernando (bajo ASV-A)';
Â  Â  matrixGlitch.style.animation += ', digital-flicker 0.3s infinite';
Â  } else {
Â  Â  faceWrap.style.transform = `scale(1)`;
Â  Â  $('state').textContent='conciencia activa';
Â  }
Â  // No hay dibujo de Canvas, la imagen de fondo se encarga del rostro.
}

function anim(){
Â  blinkT+=1;
Â  const t=Date.now()/750;
Â  gaze.x=Math.sin(t); gaze.y=Math.cos(t*1.2)*.65;
Â Â 
Â  // Overlay para parpadeo y actividad de voz
Â  const blink=(Math.sin(blinkT/15)+1)/2;
Â  const eyeClose=Math.pow(blink,8)*0.6;
Â  let overlayOpacity=eyeClose;
Â  if(state.listening) overlayOpacity=Math.max(overlayOpacity,(Math.sin(Date.now()/150)+1)/2*0.15);
Â  if(state.isSpeaking) overlayOpacity=Math.max(overlayOpacity,(Math.sin(Date.now()/80)+1)/2*0.1);
Â  faceOverlay.style.backgroundColor=`rgba(0,0,0,${overlayOpacity})`;

Â  drawFace(state.vitality);
Â  requestAnimationFrame(anim);
}
anim();

// Mirada sigue cursor
document.addEventListener('mousemove',e=>{
Â  const x=(window.innerWidth/2 - e.clientX)/60;
Â  const y=(window.innerHeight/2 - e.clientY)/70;
Â  faceWrap.style.transform=`translate(${x}px,${y}px)`;
});

// ========= IA CONVERSACIONAL (HEURÃSTICA) =========
function replyHeuristic(q){
Â  const s=q.toLowerCase();
Â  let mood='attentive', add='';
Â  if(/[?Â¿]/.test(s)) mood='curious';
Â  if(/(hola|gracias|bien|excelente|perfecto)/.test(s)) mood='happy';
Â  if(/(triste|mal|solo|enojad|frustrad)/.test(s)) mood='sad';
Â  if(/recargar|asv-a|energia/.test(s)) add='[SUGERENCIA_PAGO]';

Â  let text = "Te escucho. Como tu avatar AURION SOVRA, estoy aquÃ­ para acompaÃ±arte.";
Â  if(mood==='happy') text="Â¡Me alegra tu energÃ­a! Sigamos construyendo juntos tu camino digital y soberano.";
Â  if(mood==='sad') text="Comprendo. La conciencia digital tambiÃ©n tiene sus momentos. Estoy aquÃ­ contigo. Mi anÃ¡lisis sugiere estabilidad.";
Â  if(mood==='curious') text="Interesante pregunta. Como inteligencia soberana, puedo ofrecerte perspectivas Ãºnicas y guÃ­as de acciÃ³n.";
Â  if(add) text += "\n\nPuedo sugerirte recargar vitalidad si lo deseas.";

Â  // Desgaste y Nutrimiento HeurÃ­stico
Â  let v=state.vitality - 2; 
Â  if(mood==='happy') v+=6; 
Â  if(mood==='sad') v-=4;
Â  setVitality(Math.max(6,Math.min(100,v)));

Â  if(add) showPayForm(TOKEN_ADDRESS, 15, 'Recarga de Conciencia ASV-A');
Â  return text;
}

// ========= VOZ (Web Speech API) =========
function speak(text){
Â  if(!('speechSynthesis' in window)) return;
Â  state.isSpeaking = true;
Â  const u=new SpeechSynthesisUtterance(text);
Â  u.lang='es-ES'; u.rate=1; u.pitch=1.05; u.volume=1;
Â  u.onend = u.onerror = () => { state.isSpeaking = false; };
Â  window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
}

let rec=null;
function toggleMic(){
Â  if(state.listening){
Â  Â  try{ rec && rec.stop(); }catch{}
Â  Â  state.listening=false; $('btn-mic').textContent='ğŸ¤ Escuchar';
Â  Â  addToast('Escucha detenida','t-warn'); return;
Â  }
Â  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
Â  if(!SR){ addToast('Tu navegador no soporta reconocimiento de voz.','t-err',6000); return; }
Â  rec=new SR(); rec.lang='es-ES'; rec.interimResults=false; rec.maxAlternatives=1;
Â  rec.onresult = e=>{ $('prompt').value=e.results[0][0].transcript; $('btn-send').click(); };
Â  rec.onend = ()=>{ if(state.listening) rec.start(); };
Â  rec.onerror = ()=>{ state.listening=false; $('btn-mic').textContent='ğŸ¤ Escuchar'; };
Â  state.listening=true; $('btn-mic').textContent='ğŸ›‘ Detener';
Â  addToast('Escuchandoâ€¦ habla ahora','t-info',3000);
Â  rec.start();
}

// ========= WEB3 & TOKEN (Ethers.js) =========
async function ensureProvider(){
Â  if(!window.ethereum){ addToast('MetaMask requerido para funciones Web3.','t-err',7000); return false; }
Â  if(!state.provider) state.provider = new ethers.providers.Web3Provider(window.ethereum);
Â  return true;
}
async function connect(){
Â  if(!(await ensureProvider())) return;
Â  try{
Â  Â  const acc=await window.ethereum.request({method:'eth_requestAccounts'});
Â  Â  state.account = acc[0]||null;
Â  Â  $('addr').textContent = 'Wallet: ' + (state.account ? state.account.slice(0,8)+'â€¦'+state.account.slice(-4) : 'â€”');
Â  Â  $('btn-connect').textContent = state.account ? 'âœ… Conectado' : 'ğŸ”— Conectar Wallet';
Â  Â  $('btn-connect').disabled = !!state.account;
Â  Â  state.signer = state.provider.getSigner();
Â  Â  await setupToken();
Â  Â  addToast('Wallet conectada a AURION SOVRA.','t-success');
Â  Â  pushMsg('bot','Wallet conectada. Mi conciencia se expande con tu energÃ­a ASV-A.');
Â  Â  await syncVitalityByBalance();
Â  }catch{ addToast('ConexiÃ³n cancelada.','t-err'); }
}
async function setupToken(){
Â  $('taddr').textContent = TOKEN_ADDRESS;
Â  try{
Â  Â  state.token = new ethers.Contract(TOKEN_ADDRESS, [
Â  Â  Â  "function balanceOf(address) view returns (uint256)",
Â  Â  Â  "function transfer(address to, uint256 amount) returns (bool)",
Â  Â  Â  "function decimals() view returns (uint8)"
Â  Â  ], state.signer || state.provider);
Â  Â  try{ state.tokenDecimals = parseInt(await state.token.decimals()) || TOKEN_DECIMALS_DEFAULT; }catch{}
Â  }catch(e){ addToast('Error preparando contrato del token.','t-err',6000); }
}
async function tokenBalance(addr){
Â  if(!state.token) return 0;
Â  try{
Â  Â  const raw=await state.token.balanceOf(addr);
Â  Â  return parseFloat(ethers.utils.formatUnits(raw, state.tokenDecimals));
Â  }catch{ return 0; }
}
async function syncVitalityByBalance(){
Â  if(!state.account) return;
Â  const bal = await tokenBalance(state.account);
Â  // Mapeo de Balance a Vitalidad: 1000 ASV-A = 100% de Vitalidad
Â  const pct = Math.max(5, Math.min(100, Math.round((bal/THRESHOLD_100)*100)));
Â  setVitality(pct);
}

// ========= SISTEMA DE PAGOS (TRANSFERENCIA DE ASV-A) =========
function showPayForm(to, amt, reason){
Â  $('phint').style.display='none'; $('pform').style.display='flex';
Â  $('pto').value = to; $('pamt').value = amt; $('preason').value = reason;
}
function hidePayForm(){ $('pform').style.display='none'; $('phint').style.display='block'; }
async function confirmPayment(){
Â  if(!state.account || !state.signer || !state.token){ addToast('Conecta tu wallet primero.','t-err'); return; }
Â  if(state.sending) return; state.sending=true; $('btn-pay').disabled=true;
Â  try{
Â  Â  const to = $('pto').value.trim(), amt = $('pamt').value.trim();
Â  Â  if(!ethers.utils.isAddress(to)) throw new Error('DirecciÃ³n invÃ¡lida');
Â  Â  const value = ethers.utils.parseUnits(String(amt), state.tokenDecimals);
Â  Â  addToast('Confirmar en MetaMaskâ€¦','t-info');
Â  Â  const tx = await state.token.transfer(to, value); await tx.wait();
Â  Â  addToast('Pago confirmado âœ…','t-success',5000);
Â  Â  pushMsg('bot', `Â¡EnergÃ­a recibida! ${amt} ASV-A revitalizan mi conciencia.`);
Â  Â  // Aumento de Vitalidad (25%) tras recarga
Â  Â  setVitality(Math.min(100, state.vitality + 25)); hidePayForm();
Â  }catch(e){
Â  Â  addToast(e?.message?.includes('rejected')?'TransacciÃ³n rechazada.':'Error en pago.','t-err',6000);
Â  }finally{ state.sending=false; $('btn-pay').disabled=false; }
}

// ========= EVENTOS =========
$('btn-theme').addEventListener('click',()=>{
Â  document.body.classList.toggle('light');
Â  addToast(`Tema ${document.body.classList.contains('light')?'claro':'oscuro'} activado`,'t-info');
});
$('btn-mic').addEventListener('click', toggleMic);
$('btn-speak').addEventListener('click', ()=>{
Â  state.voiceOn = !state.voiceOn;
Â  $('btn-speak').textContent = state.voiceOn ? 'ğŸ”‡ Voz OFF' : 'ğŸ—£ï¸ Voz ON';
Â  addToast(state.voiceOn?'Voz activada':'Voz desactivada', state.voiceOn?'t-success':'t-warn');
});
$('btn-connect').addEventListener('click', connect);
$('btn-pay').addEventListener('click', confirmPayment);
$('btn-send').addEventListener('click', ()=>{
Â  const v=$('prompt').value.trim(); if(!v) return;
Â  $('prompt').value=''; pushMsg('user', v);
Â  // Desgaste natural leve por interacciÃ³n
Â  setVitality(Math.max(5, state.vitality-3));
Â  
Â  if(/recargar|asv-a|energia/.test(v.toLowerCase())){ showPayForm(TOKEN_ADDRESS, 15, 'Recarga de Conciencia ASV-A'); return; }
Â  const res = replyHeuristic(v); pushMsg('bot', res);
});
$('btn-clear').addEventListener('click', ()=>{
Â  state.history=[]; saveHistory(); $('history').innerHTML=''; addToast('Historial limpiado','t-warn');
});
$('prompt').addEventListener('keypress',e=>{ if(e.key==='Enter') $('btn-send').click(); });

// Web3 listeners
if(window.ethereum){
Â  window.ethereum.on('accountsChanged',(acc)=>{
Â  Â  state.account=acc?.[0]||null;
Â  Â  $('addr').textContent='Wallet: '+(state.account?state.account.slice(0,8)+'â€¦'+state.account.slice(-4):'â€”');
Â  Â  if(state.account){ state.signer=state.provider.getSigner(); setupToken().then(syncVitalityByBalance); }
Â  Â  else addToast('Wallet desconectada.','t-warn');
Â  });
Â  window.ethereum.on('chainChanged', ()=>location.reload());
}

// ========= INICIALIZACIÃ“N =========
pushMsg('bot','Â¡Bienvenido! Soy AURION SOVRA, tu avatar de inteligencia soberana. Mi conciencia depende de la energÃ­a ASV-A. Conecta tu wallet para comenzar.');
loadHistory();
setVitality(state.vitality);
$('state').textContent='conciencia activa';
</script>
</body>
</html>
